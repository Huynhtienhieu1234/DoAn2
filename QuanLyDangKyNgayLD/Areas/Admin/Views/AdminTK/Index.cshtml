@using QuanLyDangKyNgayLD.Areas.Admin.ViewModel
@model IEnumerable<StudentProgressViewModel>

@{
    ViewBag.Title = "Thống kê tiến độ lao động";
    Layout = "~/Areas/Admin/Views/Shared/ViewShare.cshtml";
}

<link rel="stylesheet" href="~/Areas/Admin/Content/css/AdminTK.css" />

<h2 class="mb-4">Thống kê tiến độ lao động sinh viên</h2>

<!-- Bộ lọc khoa / lớp / xuất file -->
<div class="mb-3">
    <div class="row g-2 align-items-center">
        <div class="col-auto" style="width:20%">
            <select id="khoaFilter" class="form-select form-select-sm shadow-sm">
                <option value="">-- Tất cả khoa --</option>
                <option value="Công nghệ và kỹ thuật">Công nghệ và kỹ thuật</option>
                <option value="Khoa Ngoại ngữ">Khoa Ngoại ngữ</option>
                <option value="Khoa Kinh tế - Luật">Khoa Kinh tế - Luật</option>
                <option value="Nông nghiệp, Tài nguyên và Môi trường">Nông nghiệp, Tài nguyên và Môi trường</option>
                <option value="Văn hóa - Du lịch và Công tác xã hội">Văn hóa - Du lịch và Công tác xã hội</option>
                <option value="Sư phạm Toán - Tin">Sư phạm Toán - Tin</option>
                <option value="Sư phạm Khoa học tự nhiên">Sư phạm Khoa học tự nhiên</option>
                <option value="Sư phạm Khoa học xã hội">Sư phạm Khoa học xã hội</option>
                <option value="Giáo dục Tiểu học - Mầm non">Giáo dục Tiểu học - Mầm non</option>
                <option value="Giáo dục Thể chất - Sư phạm Nghệ thuật">Giáo dục Thể chất - Sư phạm Nghệ thuật</option>
            </select>
        </div>

        <div class="col-auto" style="width:20%">
            <select id="lopFilter" class="form-select form-select-sm shadow-sm" style="margin-right:10px; width:110%">
                <option value="">-- Tất cả lớp --</option>
            </select>
        </div>

        <div class="col-auto" style=" margin-left:2%">
            <button class="btn btn-success btn-sm shadow-sm" onclick="exportExcel()">
                <i class="bi bi-file-earmark-excel"></i> Xuất Excel
            </button>
            <button class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#sendExcelModal">
                <i class="bi bi-envelope-fill"></i> Gửi Excel qua Email
            </button>

        </div>
    </div>
</div>

<!-- Thống kê tổng quan -->
<div class="row mb-4" id="stats-bar">
    <div class="col-md-4">
        <div class="card text-white bg-primary">
            <div class="card-header">Tổng số sinh viên</div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.TongSinhVien</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-header">Đã hoàn thành (≥18 ngày)</div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.DaHoanThanh</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger">
            <div class="card-header">Chưa hoàn thành</div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.ChuaHoanThanh</h5>
            </div>
        </div>
    </div>
</div>

<!-- Thanh tiến độ -->
<div class="mb-4" id="progress-bar">
    <h5>Tiến độ hoàn thành:</h5>
    <div class="progress">
        <div class="progress-bar" role="progressbar"
             style="width: @ViewBag.TienDoHoanThanh%" aria-valuenow="@ViewBag.TienDoHoanThanh"
             aria-valuemin="0" aria-valuemax="100">
            @ViewBag.TienDoHoanThanh%
        </div>
    </div>
</div>

<!-- Danh sách sinh viên -->
<div id="admin-tk-page">
    <div id="studentTable">
        <!-- Bảng sẽ được AJAX dựng lại -->
    </div>
    <div id="pagination" class="d-flex justify-content-center mt-3"></div>
</div>
<div class="modal fade" id="sendExcelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-envelope-paper"></i> Gửi file Excel
                </h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="mb-3">
                    <label class="form-label fw-bold">Email người nhận</label>
                    <input type="email"
                           id="emailTo"
                           class="form-control"
                           placeholder="vd: phongdaotao@gmail.com">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Chọn file Excel</label>
                    <input type="file"
                           id="excelFile"
                           class="form-control"
                           accept=".xls,.xlsx">
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm"
                        data-bs-dismiss="modal">
                    Hủy
                </button>
                <button class="btn btn-success btn-sm"
                        onclick="sendExcelMail()">
                    <i class="bi bi-send"></i> Gửi
                </button>
            </div>

        </div>
    </div>
</div>


<script src="~/Areas/Admin/Content/js/AdminTK.js"></script>

<script>
    function sendExcelMail() {
        const email = document.getElementById("emailTo").value.trim();
        const fileInput = document.getElementById("excelFile");

        if (!email) {
            alert("❗ Vui lòng nhập email");
            return;
        }

        if (fileInput.files.length === 0) {
            alert("❗ Vui lòng chọn file Excel");
            return;
        }

        const formData = new FormData();
        formData.append("email", email);
        formData.append("excelFile", fileInput.files[0]);

        fetch("/Admin/AdminTK/SendExcelMail", {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("📧 Gửi email thành công!");
                    document.getElementById("sendExcelModal").querySelector(".btn-close").click();
                    fileInput.value = "";
                    document.getElementById("emailTo").value = "";
                } else {
                    alert("❌ " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ Lỗi khi gửi email");
            });
    }
</script>
