@{
    ViewBag.Title = "Đặt lại mật khẩu";
    Layout = null;
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/Huynhtienhieu1234/UploadAnh/logoxoanen.png" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background: url('https://cdn.jsdelivr.net/gh/Huynhtienhieu1234/UploadAnh/Nen.png') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Segoe UI', sans-serif;
        }
        .logo { width: 120px; margin-bottom: 10px; }
        .card { min-width: 340px; max-width: 420px; border-radius: 16px; }

        /* Password wrapper */
        .password-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .password-wrapper input { padding-right: 44px; }
        .password-wrapper .toggle-eye {
            position: absolute;
            top: 70%; right: 12px;
            transform: translateY(-50%);
            background: none; border: none;
            color: #666; cursor: pointer;
            font-size: 17px;
        }
        .password-wrapper .toggle-eye:hover { color: #0d6efd; }

        /* Yêu cầu mật khẩu */
        .password-requirements {
            font-size: 0.875rem;
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        .requirement { margin: 6px 0; color: #666; }
        .requirement.valid { color: #28a745; }
        .requirement.invalid { color: #dc3545; }
        .requirement i { width: 18px; }

        /* === THÔNG BÁO BONG BÓNG HIỆN ĐẠI === */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .notification {
            min-width: 340px;
            max-width: 420px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            transform: translateX(450px);
            opacity: 0;
            animation: slideIn 0.5s ease forwards;
        }
        .notification.success { border-left: 6px solid #28a745; }
        .notification.error { border-left: 6px solid #dc3545; }

        .notification-header {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .notification.success .notification-header  { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.error   .notification-header  { background: linear-gradient(135deg, #dc3545, #fd7e14); }

        .notification-icon { font-size: 26px; }
        .notification-body {
            padding: 0 20px 16px;
            color: #333;
            font-size: 15px;
        }
        .notification-progress {
            height: 5px;
            background: rgba(0,0,0,0.15);
        }
        .notification-progress-fill {
            height: 100%;
            width: 100%;
            background: rgba(255,255,255,0.4);
            animation: countdown 4s linear forwards;
        }

        @@keyframes slideIn {
            to { transform: translateX(0); opacity: 1; }
        }
        @@keyframes slideOut {
            to { transform: translateX(450px); opacity: 0; }
        }
        @@keyframes countdown {
            from { width: 100%; }
            to   { width: 0%; }
        }
    </style>
</head>
<body>
    <!-- Bong bóng thông báo góc phải trên -->
    <div id="notification-container"></div>

    <div class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-4 shadow-lg">
            <div class="text-center mb-3">
                <img src="https://cdn.jsdelivr.net/gh/Huynhtienhieu1234/UploadAnh/LogoDHDT.png" alt="Logo" class="logo">
                <h3 class="mt-3 text-primary">Đặt lại mật khẩu</h3>
                <p class="text-muted">Vui lòng nhập mật khẩu mới</p>
            </div>

            @using (Html.BeginForm("ResetPassword", "ResetPassword", FormMethod.Post, new { id = "resetForm" }))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" name="token" value="@ViewBag.Token" />

                <!-- Hiển thị yêu cầu mật khẩu -->
                <div class="password-requirements" id="passwordRequirements">
                    <div class="requirement" id="req-length"><i class="fa fa-circle"></i> Ít nhất 6 ký tự</div>
                    <div class="requirement" id="req-number"><i class="fa fa-circle"></i> Chứa ít nhất 1 số (0-9)</div>
                    <div class="requirement" id="req-special"><i class="fa fa-circle"></i> Chứa ít nhất 1 ký tự đặc biệt (!@@#$%^&*)</div>
                </div>

                <!-- Mật khẩu mới -->
                <div class="mb-3 password-wrapper">
                    <label for="newPassword" class="form-label fw-bold">Mật khẩu mới</label>
                    <input type="password" name="newPassword" id="newPassword" class="form-control" placeholder="Nhập mật khẩu mới" required />
                    <button type="button" class="toggle-eye" onclick="togglePassword('newPassword','eye1')">
                        <i id="eye1" class="fa fa-eye"></i>
                    </button>
                </div>

                <!-- Xác nhận mật khẩu -->
                <div class="mb-3 password-wrapper">
                    <label for="confirmPassword" class="form-label fw-bold">Xác nhận mật khẩu</label>
                    <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" placeholder="Nhập lại mật khẩu" required />
                    <button type="button" class="toggle-eye" onclick="togglePassword('confirmPassword','eye2')">
                        <i id="eye2" class="fa fa-eye"></i>
                    </button>
                </div>

                <button type="submit" class="btn btn-primary w-100 fw-bold" id="submitBtn">
                    <i class="fas fa-check me-1"></i> Xác nhận đặt lại
                </button>

                <div class="text-center mt-3">
                    <a href="@Url.Action("Login", "Login")" class="text-decoration-none">
                        <i class="fa fa-arrow-left"></i> Quay lại đăng nhập
                    </a>
                </div>
            }
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Regex kiểm tra
        const regexDigit   = /\d/;
        const regexSpecial = /[!@@#$%^&*()_+\-=[\]{};':"\\|,.<>/?`~]/;

        // Toggle hiện/ẩn mật khẩu
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon  = document.getElementById(iconId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace("fa-eye", "fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.replace("fa-eye-slash", "fa-eye");
            }
        }

        // Hiển thị yêu cầu mật khẩu khi nhập
        document.getElementById('newPassword').addEventListener('input', validatePassword);
        function validatePassword() {
            const pwd = document.getElementById('newPassword').value;
            const box = document.getElementById('passwordRequirements');
            box.style.display = pwd ? 'block' : 'none';

            // Độ dài
            toggleValid('req-length', pwd.length >= 6);
            // Có số
            toggleValid('req-number', regexDigit.test(pwd));
            // Có ký tự đặc biệt
            toggleValid('req-special', regexSpecial.test(pwd));
        }
        function toggleValid(id, condition) {
            const el = document.getElementById(id);
            const icon = el.querySelector('i');
            if (condition) {
                el.classList.add('valid'); el.classList.remove('invalid');
                icon.className = 'fa fa-check-circle';
            } else {
                el.classList.add('invalid'); el.classList.remove('valid');
                icon.className = 'fa fa-times-circle';
            }
        }

        // Kiểm tra trước khi submit
        function validateForm() {
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;

            if (newPwd.length < 6)               { showNotification('Mật khẩu phải có ít nhất 6 ký tự!', 'error'); return false; }
            if (!regexDigit.test(newPwd))         { showNotification('Mật khẩu phải chứa ít nhất 1 số!', 'error'); return false; }
            if (!regexSpecial.test(newPwd))       { showNotification('Mật khẩu phải chứa ít nhất 1 ký tự đặc biệt!', 'error'); return false; }
            if (newPwd !== confirmPwd)            { showNotification('Hai mật khẩu không khớp!', 'error'); return false; }

            return true;
        }

        // === HÀM THÔNG BÁO BONG BÓNG ===
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const id = 'notif-' + Date.now();

            const icon  = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            const title = type === 'success' ? 'Thành công!' : 'Lỗi!';

            const html = `
                <div id="${id}" class="notification ${type}">
                    <div class="notification-header">
                        <i class="fas ${icon} notification-icon"></i>
                        <span>${title}</span>
                    </div>
                    <div class="notification-body">${message}</div>
                    <div class="notification-progress">
                        <div class="notification-progress-fill"></div>
                    </div>
                </div>`;

            container.insertAdjacentHTML('beforeend', html);

            // Tự động ẩn + chuyển hướng nếu thành công
            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.animation = 'slideOut 0.5s forwards';
                    setTimeout(() => el.remove(), 500);
                }
                if (type === 'success') {
                    setTimeout(() => {
                        window.location.href = "@Url.Action("Login", "Login")";
                    }, 600);
                }
            }, 4000);
        }

        // Ngăn submit nếu không hợp lệ
        document.getElementById('resetForm').addEventListener('submit', function (e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });

        // Hiển thị thông báo từ TempData (server-side)
        document.addEventListener('DOMContentLoaded', function () {
            @if (TempData["ErrorMessage"] != null)
            {
                @:showNotification('@TempData["ErrorMessage"]', 'error');
            }
            else if (TempData["SuccessMessage"] != null)
            {
                @:showNotification('@TempData["SuccessMessage"]', 'success');
            }
        });
    </script>
</body>
</html>